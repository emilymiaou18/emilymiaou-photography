---
import Heading from '@/components/Heading.astro';
import { Badge } from '@/components/ui/badge';
import { buttonVariants } from '@/components/ui/button';
import { type LanguageCode, defaultLanguage, type ui } from '@/i18n/ui';
import { Image } from 'astro:assets';
import { Code, ExternalLink } from 'lucide-react';
import ProjectGallery from '../components/ProjectGallery';
import type { TranslatedProject } from '../type';

export type Props = {
  project: TranslatedProject;
  t: (typeof ui)[LanguageCode];
  lang: LanguageCode;
};

const { project, t, lang } = Astro.props;

const verticalImages = project.galleryImagesTranslated?.filter((img) => img.id.includes('vertical'));
const horizontalImages = project.galleryImagesTranslated?.filter((img) => img.id.includes('horizontal'));
---

<div class="py-12 md:py-16">
  <article class="prose lg:prose-xl max-w-none dark:prose-invert">
    <a
      href={`${lang !== defaultLanguage ? `/${lang}` : ''}/weddings`}
      class={buttonVariants({ variant: 'ghost' }) + ' mb-6 no-underline'}
    >
      &larr; {t.projectDetailPage?.backToProjects ?? 'Back to Weddings'}
    </a>

    <Heading title={project.title} />
    <div
      class="mb-4 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600 dark:text-gray-400"
    >
      <!-- Category -->
      {
        project.categoryText && (
          <div class="flex items-center gap-2">
            <span class="text-foreground">
              {t.projectDetailPage?.categoryLabel ?? 'Category'}
            </span>
            <Badge variant="secondary">{project.categoryText}</Badge>
          </div>
        )
      }
      <!-- Date -->
      {
        project.dateText && (
          <div class="flex items-center gap-2">
            <span class="text-foreground">
              {t.projectDetailPage?.dateLabel ?? 'Date'}
            </span>
            <Badge variant="secondary">{project.dateText}</Badge>
          </div>
        )
      }
    </div>

    <!-- Detailed Description -->
    {
      project.detailedDescription && (
        <section class="mb-8">
          <h2>{t.projectDetailPage?.aboutTitle ?? 'About this project'}</h2>
          <p>{project.detailedDescription}</p>
        </section>
      )
    }
    
    {/* Gallery */}
    {
      horizontalImages && verticalImages && verticalImages.length > 0 && horizontalImages.length > 0 && (
        <div class="mb-2 flex flex-col gap-2">
          {
            Array.from({ length: Math.min(verticalImages.length, horizontalImages.length)}).map((_, rowIndex) => {
              const isEvenRow = rowIndex % 2 === 0;
              const horizontalImg= horizontalImages[rowIndex];
              const verticalImg = verticalImages[rowIndex];

              // Only include images that exist, respecting order
              const images = isEvenRow ? [horizontalImg, verticalImg] : [verticalImg, horizontalImg];
              const aspectRatios = isEvenRow ? [3 / 2, 2 / 3] : [2 / 3, 3 / 2];
              return (
                <div class="flex gap-2 h-[500px] justify-center">
                  {images.map((img, i) => {
                    const width = 500 * aspectRatios[i]; // fixed height = 680px
                    return (
                      <div
                        class="h-full flex-shrink-0"
                        style={{ width: `${width}px` }}
                      >
                        <Image
                          src={img.src}
                          alt=""
                          class="w-full h-full object-cover rounded-md"
                          loading="lazy"
                          quality="high"
                        />
                      </div>
                    );
                  })}
                </div>
              );
            })
          }
        </div>
      )
    }


    



    {
      (project.challenges || project.learnings) && (
        <div class="grid grid-cols-1 md:gap-8 md:grid-cols-2 md:mb-8 mb-4">
          {project.challenges && (
            <section>
              <h2 class="mt-0">
                {t.projectDetailPage?.challengesTitle ?? 'Challenges'}
              </h2>
              <p>{project.challenges ?? 'Challenges'}</p>
            </section>
          )}

          {project.learnings && (
            <section>
              <h2 class="mt-0">
                {t.projectDetailPage?.learningsTitle ?? 'Learnings'}
              </h2>
              <p>{project.learnings ?? 'Learnings'}</p>
            </section>
          )}
        </div>
      )
    }

    {/* Project and Code URLs */}
    <div class="mt-8 flex flex-wrap gap-4">
      {
        project.projectUrl && (
          <a
            href={project.projectUrl}
            target="_blank"
            rel="noopener noreferrer"
            class={
              buttonVariants({ variant: 'default' }) + ' flex-1 no-underline'
            }
          >
            <ExternalLink className="mr-2 size-4" />
            {t.projectDetailPage?.visitProjectButton ?? 'Visit Project'}
          </a>
        )
      }
      {
        project.codeUrl && (
          <a
            href={project.codeUrl}
            target="_blank"
            rel="noopener noreferrer"
            class={
              buttonVariants({ variant: 'secondary' }) + ' flex-1 no-underline'
            }
          >
            <Code className="mr-2 size-4" />
            {t.projectDetailPage?.viewCodeButton ?? 'View Code'}
          </a>
        )
      }
    </div>
  </article>
</div>
